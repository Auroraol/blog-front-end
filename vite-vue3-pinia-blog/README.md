### åç«¯æŠ€æœ¯

| æŠ€æœ¯            | è¯´æ˜                       | å®˜ç½‘é“¾æ¥                                                     |
| --------------- | -------------------------- | ------------------------------------------------------------ |
| Spring Boot     | MVC æ¡†æ¶                   | [https://spring.io/projects/spring-boot](https://spring.io/projects/spring-boot) |
| Spring Security | è®¤è¯å’Œæˆæƒå®‰å…¨æ¡†æ¶         | [https://spring.io/projects/spring-security](https://spring.io/projects/spring-security) |
| MyBatis Plus    | ORM æ¡†æ¶                   | [https://mp.baomidou.com](https://mp.baomidou.com)           |
| Knife4j         | æ¥å£æ–‡æ¡£ç®¡ç†æ¡†æ¶           | [https://doc.xiaominfo.com](https://doc.xiaominfo.com)       |
| Redis           | ç¼“å­˜æ¡†æ¶                   | [https://redis.io](https://redis.io)                         |
| Lombok          | å¯¹è±¡å°è£…å·¥å…·               | [https://github.com/projectlombok/lombok](https://github.com/projectlombok/lombok) |
| Nginx           | Http å’Œåå‘ä»£ç† Web æœåŠ¡å™¨ | [http://nginx.org](http://nginx.org)                         |
| JustAuth        | ç¬¬ä¸‰æ–¹ç™»å½•å·¥å…·             | [https://www.justauth.cn](https://www.justauth.cn)           |

### å‰ç«¯æŠ€æœ¯

| è¯´æ˜             | å®˜ç½‘                                                         |
| ---------------- | ------------------------------------------------------------ |
| å‰ç«¯æ¡†æ¶         | [https://vuejs.org](https://vuejs.org)                       |
| è·¯ç”±æ¡†æ¶         | [https://router.vuejs.org](https://router.vuejs.org)         |
| å…¨å±€çŠ¶æ€ç®¡ç†æ¡†æ¶ | [https://vuex.vuejs.org](https://vuex.vuejs.org)             |
| å‰ç«¯ UI æ¡†æ¶     | [https://element-plus.gitee.io](https://element-plus.gitee.io) |
| å‰ç«¯ Http æ¡†æ¶   | [https://github.com/axios/axios](https://github.com/axios/axios) |
| å¯Œæ–‡æœ¬ç¼–è¾‘å™¨     | [https://www.wangeditor.com](https://www.wangeditor.com)     |
| Markdown ç¼–è¾‘å™¨  | [http://ckang1229.gitee.io/vue-markdown-editor/zh](http://ckang1229.gitee.io/vue-markdown-editor/zh) |
| ä»£ç è¯­æ³•é«˜äº®æ’ä»¶ | [https://github.com/highlightjs/highlight.js](https://github.com/highlightjs/highlight.js) |

## License

# è¯´æ˜

## å‰ç«¯

**å‰ç«¯æ¡†æ¶**ï¼š**vite-vue3**

- è‡ªåŠ¨å¯¼å…¥: [unplugin-auto-import]()
- Markdown åœ¨çº¿ç¼–è¾‘å™¨: [MdEditorV3 ](https://imzbf.github.io/md-editor-v3/zh-CN/demo#ğŸ¥± Setup æ¨¡æ¿) 
  + å‚è€ƒ: [ä½¿ç”¨è¯´æ˜](https://blog.csdn.net/qq_16992475/article/details/130899269)
- Hook&api: [VueHook Plus](https://inhiblab-core.gitee.io/docs/hooks/guide/)
- çŠ¶æ€ç®¡ç†åº“: [pinia](https://pinia.vuejs.org/api/modules/pinia.html#Type-Aliases)
- UI:
  - [Element Plus ](https://element-plus.org/zh-CN/component/button.html)
  - [iconfont-é˜¿é‡Œå·´å·´çŸ¢é‡å›¾æ ‡åº“](https://www.iconfont.cn/?spm=a313x.search_index.i3.2.52c93a81WpIhXZ)
- å…¶ä»–: htmlã€cssã€ lessã€ js
- åŠ¨ç”»: [GSAP ](https://gsap.framer.wiki/)

## åç«¯

**åç«¯æ¡†æ¶: springboot**

- å…¨æ–‡æœç´¢å¼•æ“: es
- æ•°æ®åº“å®šæœŸå¤‡ä»½å’Œå®šæœŸåˆ é™¤
- æ•°æ®åº“: Mybatis(MySQL)
- å®æ—¶æ¨é€: WebSocket
- JMX
- åˆ†å¸ƒå¼ç›¸å…³ï¼š

  - Redis(åˆ†å¸ƒå¼ç¼“å­˜)
  - Redisson(åˆ†å¸ƒå¼é”)

- äººè„¸è¯†åˆ«
- æ•æ„Ÿæ•°æ®çš„ä¿æŠ¤ä¼â€”â€”SpringBooté›†æˆjasypt

## å…¶ä»–

**éƒ¨ç½²**ï¼šTomcatã€Nginxã€é˜¿é‡Œäº‘æœåŠ¡å™¨ã€ä¸ƒç‰›äº‘ CDN

**Python ç›¸å…³**ï¼šç™¾åº¦ç»Ÿè®¡çš„è·å–ã€Flask æä¾›æ–‡æœ¬åˆ†æ API

**å…¶ä»–**ï¼šMongoDBï¼ˆç›®å‰åªç”¨æ¥è®°å½•æ•°æ®åº“å¯åŠ¨ï¼‰ã€RabbitMQï¼ˆç›®å‰åªç”¨æ¥è®°å½•è¯·æ±‚ï¼‰ã€ç•…è¨€

---

æ—¥å¿—ç³»ç»Ÿçš„å»ºç«‹

å‚è€ƒ:

- æ–‡ç«  4.æ—¥å¿—ç³»ç»Ÿ.md

---

nginx è´Ÿè½½å‡è¡¡

å‚è€ƒ:

- nginx ä½¿ç”¨

---

ç½‘ç«™æ€§èƒ½ä¼˜åŒ–

å‚è€ƒ:

- ç½‘ç«™æ€§èƒ½ä¼˜åŒ–.md

# ç™»å½•-JWT+Redis ç¼“å­˜

## æ¥å£è¯´æ˜

æ¥å£urlï¼šhttp://localhost:9000/user/login

è¯·æ±‚æ–¹å¼ï¼šPOST  

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°åç§°     | å‚æ•°ç±»å‹ | è¯´æ˜   |
| ------------ | -------- | ------ |
| **username** | string   | ç”¨æˆ·å |
| **password** | string   | å¯†ç    |

è¿”å›æ•°æ®ï¼š

~~~json
{
    "code": 200000,
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyQ29udGV4dCI6IntcImlkXCI6XCIxXCIsXCJpc1N1cGVyXCI6ZmFsc2UsXCJsb25nVGVybVwiOmZhbHNlLFwibmlja05hbWVcIjpcImxmalwiLFwicm9sZVwiOjEsXCJ1c2VybmFtZVwiOlwibGZqXCJ9Iiwic3ViIjoibGZqIiwiZXhwIjoxNzEwNjgxODczfQ.njjSGM2Y_t06P6tq-rG11blawBLaf8pZvsdxVMxh9jY",
        "refreshToken": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyQ29udGV4dCI6IntcImlkXCI6XCIxXCIsXCJpc1N1cGVyXCI6ZmFsc2UsXCJsb25nVGVybVwiOmZhbHNlLFwibmlja05hbWVcIjpcImxmalwiLFwicm9sZVwiOjEsXCJ1c2VybmFtZVwiOlwibGZqXCJ9Iiwic3ViIjoibGZqIiwiZXhwIjoxNzExMzczMDczfQ.wbkRtLAyuXbeCGXTkU6g1wCxNVw9IeVqV8NlYl6mkfA"
    },
    "message": "å“åº”æˆåŠŸ"
}
~~~

## ç”¨æˆ·å®ä½“ç±»

```java
package com.lfj.blog.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

/**
 * @TableName user
 */
@TableName(value = "user")
@Data
public class User implements Serializable {
	@TableField(exist = false)
	private static final long serialVersionUID = 1L;
	/**
	 *
	 */
	@TableId(value = "id", type = IdType.AUTO)
	private Integer id;
	/**
	 *
	 */
	@TableField(value = "phone")
	private String phone;
	/**
	 *
	 */
	@TableField(value = "username")
	private String username;
	/**
	 *
	 */
	@TableField(value = "password")
	private String password;
	/**
	 *
	 */
	@TableField(value = "gender")
	private String gender;
	/**
	 *
	 */
	@TableField(value = "trueName")
	private String truename;
	/**
	 *
	 */
	@TableField(value = "birthday")
	private String birthday;
	/**
	 *
	 */
	@TableField(value = "email")
	private String email;
	/**
	 *
	 */
	@TableField(value = "personalBrief")
	private String personalbrief;
	/**
	 *
	 */
	@TableField(value = "avatarImgUrl")
	private String avatarimgurl;
	/**
	 *
	 */
	@JsonFormat(locale = "zh", timezone = "GMT+8", pattern = "yyyy-MM-dd HH:mm:ss")
	@TableField(value = "recentlyLanded")
	private LocalDateTime recentlylanded;
}
```



```sql
-- ----------------------------
-- Table structure for user
-- ----------------------------
DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `phone` varchar(255) NOT NULL,
  `username` varchar(255) NOT NULL,
  `password` varchar(255) NOT NULL,
  `gender` char(255) NOT NULL,
  `trueName` varchar(255) DEFAULT NULL,
  `birthday` varchar(255) DEFAULT NULL,
  `email` varchar(255) DEFAULT NULL,
  `personalBrief` varchar(255) DEFAULT NULL,
  `avatarImgUrl` text NOT NULL,
  `recentlyLanded` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of user
-- ----------------------------
INSERT INTO `user` VALUES ('1', '19940790216', 'å¼ æµ·æ´‹', 'a3caed36f0fe5a01e5f144db8927235e', 'male', 'å¼ æµ·æ´‹', '1997-07-05', '1125694337@qq.com', '', 'https://zhy-myblog.oss-cn-shenzhen.aliyuncs.com/public/user/avatar/å¼ æµ·æ´‹/1575283189.png', '2019-12-02 18:31:15');

-- ----------------------------
-- Table structure for user_role
-- ----------------------------
DROP TABLE IF EXISTS `user_role`;
CREATE TABLE `user_role` (
  `User_id` int(11) NOT NULL,
  `Role_id` int(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of user_role
-- ----------------------------
INSERT INTO `user_role` VALUES ('1', '1');
INSERT INTO `user_role` VALUES ('1', '2');
INSERT INTO `user_role` VALUES ('1', '3');

```

## Token å®ä½“ç±»

### Token å®ä½“ç±»

```java
package com.mszlu.shop.common.security;

import lombok.Data;

/**
 * Token å®ä½“ç±»
 */
@Data
public class Token {
    /**
     * è®¿é—®token
     */
    private String accessToken;

    /**
     * åˆ·æ–°token
     */
    private String refreshToken;

}
```

### Token å®ä½“ç±»å­˜æ”¾çš„ä¿¡æ¯

```java
package com.lfj.blog.common.security;


import lombok.AllArgsConstructor;
import lombok.Data;

import java.io.Serializable;

/**
 * @Author: LFJ
 * @Date: 2024-03-09 17:32
 *  å­˜å‚¨åˆ°Tokenä¸­çš„ä¿¡æ¯
 */
@Data
@AllArgsConstructor
public class AuthUser implements Serializable {

	/**
	 * ç”¨æˆ·å
	 */
	private String username;

	/**
	 * æ˜µç§°
	 */
	private String nickName;

	/**
	 * id
	 */
	private String id;

	/**
	 * é•¿æœŸæœ‰æ•ˆï¼ˆç”¨äºæ‰‹æœºappç™»å½•åœºæ™¯æˆ–è€…ä¿¡ä»»åœºæ™¯ç­‰ï¼‰
	 */
	private Boolean longTerm = false;

	/**
	 * @see UserEnums
	 * è§’è‰²
	 */
	private UserEnums role;


	/**
	 * æ˜¯å¦æ˜¯è¶…çº§ç®¡ç†å‘˜
	 */
	private Boolean isSuper = false;

	public AuthUser(String username, String id, String nickName, UserEnums role) {
		this.username = username;
		this.id = id;
		this.role = role;
		this.nickName = nickName;
	}

	public AuthUser(String username, String id, UserEnums manager, String nickName, Boolean isSuper) {
		this.username = username;
		this.id = id;
		this.role = manager;
		this.isSuper = isSuper;
		this.nickName = nickName;
	}
}

```

## æ ¸å¿ƒå®ç°

![image-20240311164152147](README.assets/image-20240311164152147.png)

```java
package com.lfj.blog.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.lfj.blog.common.cache.CachePrefix;
import com.lfj.blog.common.security.AuthUser;
import com.lfj.blog.common.security.Token;
import com.lfj.blog.common.security.UserEnums;
import com.lfj.blog.common.vo.ResponseResult;
import com.lfj.blog.entity.User;
import com.lfj.blog.mapper.UserMapper;
import com.lfj.blog.service.UserService;
import com.lfj.blog.utils.token.TokenUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.util.ObjectUtils;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import java.time.LocalDateTime;
import java.util.List;
import java.util.concurrent.TimeUnit;
/**
 * @author 16658
 * @description é’ˆå¯¹è¡¨ã€userã€‘çš„æ•°æ®åº“æ“ä½œServiceå®ç°
 * @createDate 2024-03-09 17:46:34
 */
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User>
		implements UserService {

	@Autowired
	private StringRedisTemplate redisTemplate;

	public static void main(String[] args) {
		System.out.println(new BCryptPasswordEncoder().encode("123456"));
	}

	@Override
	public ResponseResult<Token> usernameLogin(String username, String password) {
		/**
		 1. æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾Memberä¿¡æ¯
		 2. å¦‚æœä¸ºnullï¼Œå°±æ˜¯ç”¨æˆ·ä¸å­˜åœ¨
		 3. å¯†ç è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é… å¯†ç ä¸æ­£ç¡®
		 4. jwt ç”Ÿæˆtoken
		 5. jwt ç”Ÿæˆtoken, tokenæ”¾å…¥rediså½“ä¸­ï¼ŒaccessToken è¿‡æœŸçŸ­ï¼Œ refreshToken è¿‡æœŸé•¿
		 **/
		LambdaQueryWrapper<User> queryWrapper = new LambdaQueryWrapper<User>()
				.eq(User::getUsername, username);
		List<User> userList = this.list(queryWrapper);

		User user = userList.get(0);
		if (ObjectUtils.isEmpty(user)) {
			return ResponseResult.accountNotFoundError();
		}

		//ç”¨çš„securityçš„å¯†ç ç±»
		if (!new BCryptPasswordEncoder().matches(password, user.getPassword())) {
			return ResponseResult.accountError();
		}

		//ä¸€èˆ¬ä¼šç™»å½•çš„æ—¶å€™ï¼Œè®°å½• ç”¨æˆ·çš„æœ€åä¸€æ¬¡ç™»å½•æ—¶é—´
		//MQ è€ƒè™‘ä½¿ç”¨mq æŠŠä¿¡æ¯å‘åˆ°mqå½“ä¸­ï¼Œç”±mqçš„æ¶ˆè´¹è€… æ¥å»æ›´æ–°1
		user.setRecentlylanded(LocalDateTime.now());
		this.updateById(user);

		Token token = genToken(user);
		return ResponseResult.success(token);
	}

	private Token genToken(User user) {
		Token token = new Token();
		// tokenå­˜æ”¾ä¿¡æ¯
		AuthUser authUser = new AuthUser(user.getUsername(), String.valueOf(user.getId()),
				user.getUsername(), UserEnums.USER);
		// 7å¤©
		String jwtAccessToken = TokenUtils.createToken(user.getUsername(), authUser, 7 * 24 * 60 * 60 * 1000L);
		token.setAccessToken(jwtAccessToken);
		redisTemplate.opsForValue().set(CachePrefix.ACCESS_TOKEN.name() + UserEnums.USER.name() + jwtAccessToken
				,"1", 7, TimeUnit.DAYS); // å‚¨å­˜åˆ°Redisä¸­ å‰ç¼€+ç”¨æˆ·ç±»å‹+jwtToken

		// 15å¤©
		//è®¾ç½®åˆ·æ–°tokenï¼Œå½“accessTokenè¿‡æœŸçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡refreshTokenæ¥ é‡æ–°è·å–accessToken è€Œä¸ç”¨è®¿é—®æ•°æ®åº“
		String jwtRefreshToken = TokenUtils.createToken(user.getUsername(), authUser, 15 * 24 * 60 * 60 * 1000L);
		token.setRefreshToken(jwtRefreshToken);
		redisTemplate.opsForValue().set(CachePrefix.REFRESH_TOKEN.name() + UserEnums.USER.name() + jwtRefreshToken
				,"1", 15, TimeUnit.DAYS);

		return token;
	}



}
```

### æ‰€éœ€æŠ€æœ¯

#### â‘ spring security  â€”â€” åŠ å¯†åŠåˆ¤æ–­å¯†ç æ˜¯å¦ç›¸åŒ

```XML
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
    <groupId>org.jasypt</groupId>
    <artifactId>jasypt-spring-boot-starter</artifactId>
</dependency>
```

æ•°æ®å­˜å…¥[æ•°æ®åº“](https://so.csdn.net/so/search?q=æ•°æ®åº“&spm=1001.2101.3001.7020)åº“æ—¶

```JAVA
public static void main(String[] args) {
System.out.println(new BCryptPasswordEncoder().encode("123456"));
}
```

å½“éœ€è¦ç™»å½•æ—¶ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™è¡Œä»£ç è¿›è¡Œè§£å¯†

```java
LambdaQueryWrapper<User> queryWrapper = new LambdaQueryWrapper<User>()
    .eq(User::getUsername, username);
List<User> userList = this.list(queryWrapper);

User user = userList.get(0);
if (ObjectUtils.isEmpty(user)) {
    return ResponseResult.accountNotFoundError();
}

//ç”¨çš„securityçš„å¯†ç ç±»
if (!new BCryptPasswordEncoder().matches(password, user.getPassword())) {
    return ResponseResult.accountError();
}
```

#### â‘¡JWT  â€”â€” ç”Ÿæˆtoken

å…·ä½“è§:      <img src="README.assets/image-20240310212945690.png" alt="image-20240310212945690" style="zoom:67%;" />

ä¾èµ–:

```xml
<!--   tokenåŠ å¯† -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.12.3</version>
</dependency>
<!--   tokenåŠ å¯†ç»“æŸ -->
```

å‚è€ƒ: [JWTä»¤ç‰Œç”Ÿæˆå’Œè§£æï¼ˆåº“ï¼šjjwt ç‰ˆæœ¬ï¼š0.12.3ï¼‰](https://blog.csdn.net/qq_45137726/article/details/135885870)

#### â‘¢Redis  â€”â€” ç¼“å­˜

å°±æ˜¯Redisç¼“å­˜çŸ¥è¯†

```java
redisTemplate.opsForValue().set(CachePrefix.REFRESH_TOKEN.name() + UserEnums.USER.name() + "jwtRefreshToken", "1", 15, TimeUnit.DAYS);
```

## æµ‹è¯•ç»“æœ

![image-20240310210444090](README.assets/image-20240310210444090.png)



#  ç™»å½•è®¤è¯

![image-20240311172134694](README.assets/image-20240311172134694.png)

##  å¯¼åŒ…

~~~xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
~~~

## securityé…ç½®ç±»

~~~java
package com.lfj.blog.config.security;

import com.lfj.blog.handler.security.CustomAccessDeniedHandler;
import com.lfj.blog.handler.security.UserAuthenticationFilter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;

/**
 * @Author: LFJ
 * @Date: 2024-03-10 22:55
 * securityé…ç½®ç±»
 */
@Slf4j
@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class UserSecurityConfig extends WebSecurityConfigurerAdapter {
	@Autowired
	private StringRedisTemplate redisTemplate;

	/**
	 * å¿½ç•¥éªŒæƒé…ç½®
	 */
	@Autowired
	private IgnoredUrlsProperties ignoredUrlsProperties;

	/**
	 * spring security æƒé™ä¸è¶³å¤„ç†
	 */
	@Autowired
	private CustomAccessDeniedHandler accessDeniedHandler;

	@Override
	protected void configure(HttpSecurity http) throws Exception {

		ExpressionUrlAuthorizationConfigurer<HttpSecurity>.ExpressionInterceptUrlRegistry registry = http
				.authorizeRequests();
		//é…ç½®çš„url ä¸éœ€è¦æˆæƒ
		for (String url : ignoredUrlsProperties.getUrls()) {
			registry.antMatchers(url).permitAll();
		}
		registry
				.and()
				//ç¦æ­¢ç½‘é¡µiframe
				.headers().frameOptions().disable()
				.and()
				.logout()
				.permitAll()
				.and()
				.authorizeRequests()
				//ä»»ä½•è¯·æ±‚
				.anyRequest()
				//éœ€è¦èº«ä»½è®¤è¯
				.authenticated()
				.and()
				//å…è®¸è·¨åŸŸ
				.cors().and()
				//å…³é—­è·¨ç«™è¯·æ±‚é˜²æŠ¤
				.csrf().disable()
				//å‰åç«¯åˆ†ç¦»é‡‡ç”¨JWT ä¸éœ€è¦session
				.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
				.and()
				//è‡ªå®šä¹‰æƒé™æ‹’ç»å¤„ç†ç±»
				.exceptionHandling().accessDeniedHandler(accessDeniedHandler)
				.and()
				//æ·»åŠ JWTè®¤è¯è¿‡æ»¤å™¨(è‡ªå®šä¹‰)
				.addFilter(new UserAuthenticationFilter(authenticationManager(), redisTemplate));
	}

}
~~~

## å¿½ç•¥é…ç½®ç±»

~~~java
package com.lfj.blog.config.security;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Configuration;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author: LFJ
 * @Date: 2024-03-10 22:57
 */
@Configuration
@ConfigurationProperties(prefix = "ignored")
@Data
public class IgnoredUrlsProperties {
	private List<String> urls = new ArrayList<>();
}

~~~

ä½¿ç”¨:   åœ¨é…ç½®æ–‡ä»¶å†™ä¸ç”¨è¿›è¡Œtokenè®¤è¯çš„è¯·æ±‚è·¯å¾„

~~~yml
ignored:
  urls:
    - /pages/**
    - /pageData/**
    - /article/**
    - /goods/**
    - /members/**
    - /category/**
    - /common/**
~~~

## è®¤è¯è¿‡æ»¤å™¨

~~~java
package com.lfj.blog.utils.token;

/**
 * @Author: LFJ
 * @Date: 2024-03-09 15:24
 */
public class SecurityKey {
	public static final String USER_CONTEXT = "userContext";

	public static final String ACCESS_TOKEN = "accessToken";
}
~~~

å®ç°

~~~java
package com.lfj.blog.handler.security;

import com.alibaba.fastjson2.JSON;
import com.baomidou.mybatisplus.core.toolkit.StringUtils;
import com.lfj.blog.common.cache.CachePrefix;
import com.lfj.blog.common.security.AuthUser;
import com.lfj.blog.common.security.UserEnums;
import com.lfj.blog.common.vo.ResponseResult;
import com.lfj.blog.utils.token.SecretKeyUtil;
import com.lfj.blog.utils.token.SecurityKey;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.ExpiredJwtException;
import io.jsonwebtoken.Jwts;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.www.BasicAuthenticationFilter;
import com.lfj.blog.utils.ResponseUtil;
import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;


/**
 * @Author: LFJ
 * @Date: 2024-03-10 22:59
 *
 * è®¤è¯ç»“æœè¿‡æ»¤å™¨
 *
 */
@Slf4j
public class UserAuthenticationFilter extends BasicAuthenticationFilter {
	private StringRedisTemplate redisTemplate;

	/**
	 * è‡ªå®šä¹‰æ„é€ å™¨
	 *
	 * @param authenticationManager
	 */
	public UserAuthenticationFilter(AuthenticationManager authenticationManager
			, StringRedisTemplate redisTemplate) {
		super(authenticationManager);
		this.redisTemplate = redisTemplate;
	}

	@Override
	protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws IOException, ServletException, IOException {

		//ä»headerä¸­è·å–jwt
		String jwt = request.getHeader(SecurityKey.ACCESS_TOKEN);
		try {
			//å¦‚æœæ²¡æœ‰token åˆ™return
			if (StringUtils.isBlank(jwt)) {
				chain.doFilter(request, response);
				return;
			}
			//è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå­˜å…¥context
			UsernamePasswordAuthenticationToken authentication = getAuthentication(jwt, response);
			SecurityContextHolder.getContext().setAuthentication(authentication);
		} catch (Exception e) {
			log.error("BuyerAuthenticationFilter-> member authentication exception:", e);
		}
		chain.doFilter(request, response);
	}

	/**
	 * è§£æç”¨æˆ·
	 * è¯»å–Tokenä¿¡æ¯ï¼Œåˆ›å»ºUsernamePasswordAuthenticationTokenå¯¹è±¡
	 * @param jwt
	 * @param response
	 * @return
	 */
	private UsernamePasswordAuthenticationToken getAuthentication(String jwt, HttpServletResponse response) {

		try {
			Claims claims = Jwts.parser()
					.verifyWith(SecretKeyUtil.generalKey()) // ä¼ é€’å¯†é’¥
					.build()
					.parseSignedClaims(jwt)//ä¼ é€’jwtä»¤ç‰Œå‚æ•°
					.getPayload();  // è·å–- Payload(æœ‰æ•ˆè½½è·ï¼‰
			//è·å–å­˜å‚¨åœ¨claimsä¸­çš„ç”¨æˆ·ä¿¡æ¯
			String json = claims.get(SecurityKey.USER_CONTEXT).toString();
			AuthUser authUser = JSON.parseObject(json, AuthUser.class);

			//æ ¡éªŒredisä¸­æ˜¯å¦æœ‰æƒé™
			Boolean hasKey = redisTemplate.hasKey(CachePrefix.ACCESS_TOKEN.name() + UserEnums.USER.name() + jwt);
			if (hasKey != null && hasKey) {
				//æ„é€ è¿”å›ä¿¡æ¯
				List<GrantedAuthority> auths = new ArrayList<>();
				auths.add(new SimpleGrantedAuthority("ROLE_" + authUser.getRole().name()));
				UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(authUser.getUsername(), null, auths);
				authentication.setDetails(authUser);
				return authentication;
			}
			ResponseUtil.output(response, 401001, ResponseResult.noLogin());
			return null;
		} catch (ExpiredJwtException e) {
			log.debug("user analysis exception:", e);
		} catch (Exception e) {
			log.error("user analysis exception:", e);
		}
		return null;
	}
}
~~~

##  è®¤è¯å¤±è´¥çš„è¿”å›æƒé™ä¸è¶³

~~~java
package com.lfj.blog.handler.security;

import com.lfj.blog.common.vo.ResponseResult;
import com.lfj.blog.utils.ResponseUtil;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.web.access.AccessDeniedHandler;
import org.springframework.stereotype.Component;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
/**
 * @Author: LFJ
 * @Date: 2024-03-10 23:13
 * è®¤è¯å¤±è´¥çš„è¿”å›
 */
@Component
public class CustomAccessDeniedHandler implements AccessDeniedHandler {
	@Override
	public void handle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AccessDeniedException e) throws IOException, ServletException {
		ResponseUtil.output(httpServletResponse, ResponseResult.noPermission());
	}
}
~~~

## å·¥å…·ç±»

**ä½œç”¨:  ç”¨äºä»»ä½•åœ°æ–¹å‘èµ·å“åº”æ•°æ®**

~~~java
package com.lfj.blog.utils;

import com.alibaba.fastjson2.JSON;
import com.lfj.blog.common.vo.ResponseResult;
import lombok.extern.slf4j.Slf4j;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * @Author: LFJ
 * @Date: 2024-03-10 23:14
 * response è¾“å‡ºå“åº”å·¥å…·, ç”¨äºä»»ä½•åœ°æ–¹å‘èµ·å“åº”æ•°æ®, ä¸éœ€è¦PostMapping()ç­‰ç­‰
 */
@Slf4j
public class ResponseUtil {

	static final String ENCODING = "UTF-8";
	static final String CONTENT_TYPE = "application/json;charset=UTF-8";

	/**
	 * è¾“å‡ºå‰ç«¯å†…å®¹ä»¥åŠçŠ¶æ€æŒ‡å®š
	 *
	 * @param response
	 * @param status
	 * @param content
	 */
	public static void output(HttpServletResponse response, Integer status, String content) {
		ServletOutputStream servletOutputStream = null;
		try {
			response.setCharacterEncoding(ENCODING);
			response.setContentType(CONTENT_TYPE);
			response.setStatus(status);
			servletOutputStream = response.getOutputStream();
			servletOutputStream.write(content.getBytes());
		} catch (Exception e) {
			log.error("response output error: ", e);
		} finally {
			if (servletOutputStream != null) {
				try {
					servletOutputStream.flush();
					servletOutputStream.close();
				} catch (IOException e) {
					log.error("response output IO close error:", e);
				}
			}
		}
	}


	/**
	 * response è¾“å‡ºJSON
	 *
	 * @param response
	 * @param status    response çŠ¶æ€
	 * @param result
	 */
	public static void output(HttpServletResponse response, Integer status, ResponseResult result) {
		response.setStatus(status);
		output(response, result);
	}


	/**
	 * response è¾“å‡ºJSON
	 *
	 * @param response
	 * @param result
	 */
	public static void output(HttpServletResponse response, ResponseResult result) {
		ServletOutputStream servletOutputStream = null;
		try {
			response.setCharacterEncoding(ENCODING);
			response.setContentType(CONTENT_TYPE);
			servletOutputStream = response.getOutputStream();
			servletOutputStream.write(JSON.toJSONString(result).getBytes());
		} catch (Exception e) {
			log.error("response output error:", e);
		} finally {
			if (servletOutputStream != null) {
				try {
					servletOutputStream.flush();
					servletOutputStream.close();
				} catch (IOException e) {
					log.error("response output IO close error:", e);
				}
			}
		}
	}
}
~~~

## æµ‹è¯•ç»“æœ

**æƒ…å†µ1:  è¯·æ±‚å¤´æ²¡å¸¦token, è¿”å›ç©º**

![image-20240311170523945](README.assets/image-20240311170523945.png)

**æƒ…å†µ2:  è¯·æ±‚å¤´å¸¦è¿‡æœŸtoken, è¿”å›ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•**



åˆ é™¤Redis



**æƒ…å†µ2:  è¯·æ±‚å¤´å¸¦æœ‰æ•ˆtoken, è¿”å›æˆåŠŸå“åº”æ•°æ®**

![image-20240311191415030](README.assets/image-20240311191415030.png)





# æ›´æ–°æ˜µç§°

![image-20240315233101784](README.assets/image-20240315233101784.png)

![image-20240315233045253](README.assets/image-20240315233045253.png)



# è¡¨è®¾è®¡

## ç”¨æˆ·è¡¨ï¼šuser

| åç§°           | ç±»å‹    | é•¿åº¦ | ä¸»é”®  | éç©º  | æè¿°         |
| -------------- | ------- | ---- | ----- | ----- | ------------ |
| id             | int     | 11   | true  | true  | ä¸»é”®ï¼Œè‡ªå¢   |
| phone          | varchar | 255  | false | true  | æ‰‹æœºå·       |
| username       | varchar | 255  | false | true  | ç”¨æˆ·å       |
| password       | varchar | 255  | false | true  | å¯†ç          |
| gender         | char    | 50   | false | true  | æ€§åˆ«         |
| trueName       | varchar | 255  | false | false | å§“å         |
| birthday       | char    | 100  | false | false | ç”Ÿæ—¥         |
| email          | varchar | 255  | false | false | é‚®ç®±         |
| personalBrief  | varchar | 255  | false | false | ä¸ªäººç®€ä»‹     |
| avatarImgUrl   | varchar | 255  | false | true  | å¤´åƒurl      |
| recentlyLanded | varchar | 255  | false | false | æœ€è¿‘ç™»å½•æ—¶é—´ |





# ä¸ªäººä¸­å¿ƒ

![image-20240318225848609](README.assets/image-20240318225848609.png)





# æ–‡ç« 

## ä½¿ç”¨md-editor-v3

å†™æ–‡ç« 

```vue
<template>
  <MdEditor v-model="text" previewTheme="vuepress" codeTheme="a11y"/>
</template>

<script setup>
import { ref } from 'vue';
import { MdEditor } from 'md-editor-v3';
import 'md-editor-v3/lib/style.css';

const text = ref('Hello Editor!');
</script>
```

çœ‹æ–‡ç« 

```vue
<template>
	<!--æ–‡ç« å†…å®¹-->
  <MdPreview :editorId="id" :modelValue="text" previewTheme="vuepress" codeTheme="a11y"/>
	<!--æ–‡ç« ç›®å½•-->
  <MdCatalog :editorId="id" :scrollElement="scrollElement" />
</template>

<script setup>
import { ref } from 'vue';
import { MdPreview, MdCatalog } from 'md-editor-v3';
// preview.cssç›¸æ¯”style.csså°‘äº†ç¼–è¾‘å™¨é‚£éƒ¨åˆ†æ ·å¼
import 'md-editor-v3/lib/preview.css';

const id = 'preview-only';
const text = ref(`
# Hello Editor
# Hello 
This is a sample Markdown content. You can use Markdown syntax to format text, such as:

- **Bold text**
- *Italic text*
- Code blocks

\`\`\`javascript
function greet(name) {
    return 'Hello, ' + name + '!';
}
\`\`\`
## ç¬¬ä¸€
Enjoy writing in Markdown!
## ç¬¬äºŒ
### ä¸€
`);
    
//md-catalogç›®å½•çš„ç›‘å¬è®¾ç½®    
const scrollElement = document.documentElement;
</script>
```

**æ•ˆæœ**

![image-20240319172604269](README.assets/image-20240319172604269.png)

